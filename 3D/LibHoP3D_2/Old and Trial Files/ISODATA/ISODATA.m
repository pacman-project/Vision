% unknown implementation of ISODATA


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%%               ISODATA??????·?????????1.00                       %%% 
%%%          ??·????????§??????¶?????                %%% 
%%%   ???«°????¶?????????¶±??·?????????? 2.4.4?¶¶??¬????·??·??·?3?µ??  %%% 
%%%          ?????·????????????¶?±????¬±?·?·?????·¶????RunDemo.m      %%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%   ????????µ????? 
%   c                   ?¤??µ????? 
%   Nc                  ???????????????? 
%   MinMemb             ???»????????µ????????????? 
%   MinSauare           ????±???????????????jiu·??? 
%   JionLevel           ????????µ??????????¬µ????????????????? 
%   L                   ????µ???????????µ???µ???¶?¶??? 
%   MaxLoops            ????µ?????µ??????? 
%   RawData             ????????????????,[x1,x2,x3,x4...xn] 
%   ·µ»??µ???????? 
%   Final.Err           ????????µ???±????? 
%   Final.Result        2 * n?????¬??????????±?µ?·???????????????????µ??·?????? 
%   Final.ClassCenter   nDIm*Nc?????¬????Nc??????µ??»?? 
%   Hinal.nLOOP         ????µ?????¶????? 


function Final = ISODATA(RawData,c,Nc,MinMemb,MinSquare,JoinLevel,L,MaxLoops) 

    nLOOP = 0;              % current iteration
    
    nSize = size(RawData); 
    nDim = nSize(1);        %?????¬?? 
    nTotalData = nSize(2);  %??±????? 
 
     
    Final.Err = '???·????'; %·µ»??µ?????????? 
    Final.Result = 0;       %·µ»??µ??·???????????????±??????????? 
    Final.ClassCenter = zeros(nDim,c); %·µ»??µ??????µ????? 
 
     
    %??¶???????·??? 
    if c>nTotalData 
        Final.Err = '????»??§°????­?????¤????????????±?????,c'; 
        return ; 
    end 
    if Nc>=nTotalData 
        Final.Err =  '????»??§°????­????????????????µ?????±?????,Nc'; 
        return; 
    end 
    %?????????????¬?????????¶µ?Nc??????????????µ????????? 
    %Z?????????»??????µ?????µ??????? 
    Z = zeros(nDim,Nc); 
    %???µ????¶??«?µµ?µ???±?????µ??»??µ??????¬????µ????¬????µ???µ? 
    %??????·???µ?¶?µ? 
    MaxN = zeros(1,nTotalData); 
    %??????????±?µ??«?µ???? 
    for IndexI = 1:nDim 
        SubMax = RawData(IndexI,1); 
        SubN = 1; 
        for IndexJ = 1:nTotalData 
            dDot = RawData(IndexI,IndexJ); 
            if SubMax<=dDot 
                SubN = IndexJ; 
                SubMax = dDot; 
            end 
            MaxN(SubN) = MaxN(SubN)+1; 
        end 
    end 
    %??µ??«?µ??¶?µ???±? 
    SubMax = MaxN(1); 
    SubMaxN = 1; 
    for IndexI = 1:nTotalData 
        if (SubMax<=MaxN(IndexI)) 
            SubMax=MaxN(IndexI); 
            SubMaxN = IndexI; 
        end 
    end 
    Z(:,1) = RawData(:,SubMaxN); 
     
     
    CenterXY = Z(:,1); 
    for IndexI = 2:Nc 
        %??µ???µ±?°???????¶µ???±????????»????IndexIµ????? 
        MaxDis = -1e9; 
        MaxN = 0; 
        for IndexJ = 1:nTotalData 
            dDot = (RawData(:,IndexJ)-CenterXY)'*(RawData(:,IndexJ)-CenterXY); 
            if MaxDis<=dDot 
                MaxN = IndexJ; 
                MaxDis = dDot; 
            end 
        end 
        %??????µ????? 
        Z(:,IndexI) = RawData(:,MaxN); 
        %???????? 
        CenterXY = CenterXY +  Z(:,IndexI); 
        CenterXY = CenterXY/2; 
         
    end 
     
     
     
    nZ = zeros(Nc,1); 
    %Result??????·???????µ????????¬Result(1,i)±???µ?i??????µ?????Result(2,i)±????????? 
    Result = zeros(2,nTotalData); 
     
    %?????????­»·?????»±?»??¬?µ??µ??????????? 
    OldResult = Result; 
     
    %????µ??????????°????????????µ??????­»· 
    while (nLOOP<=MaxLoops) 
        %µ?nLOOP??µ??? 
        nLOOP = nLOOP + 1; 
        %????2,°????????????­??????·??? 
        bSepOK = 0; 
        nZ = zeros(Nc,1); 
        while (bSepOK==0) 
            d = zeros(nTotalData,Nc); 
            for IndexI = 1:nTotalData   %¶?xi????·??? 
                dMinN = 0; 
                dMin = Inf; 
                for IndexJ = 1:Nc       %·?±???????????????µ????? 
                    dDot = (RawData(:,IndexI)-Z(:,IndexJ))'*(RawData(:,IndexI)-Z(:,IndexJ)); 
                    d(IndexI,IndexJ) = sqrt(dDot); 
                    if dMin>d(IndexI,IndexJ) 
                        dMin = d(IndexI,IndexJ); 
                        dMinN = IndexJ; 
                    end 
                end 
                Result(1,IndexI) = dMinN; 
                Result(2,IndexI) = dMin; 
                nZ(dMinN) = nZ(dMinN)+1; 
            end 
 
            %??¶?·?????·????????»????????µ?????????????µ????? 
            OK = 1; 
            for IndexI = 1:Nc 
                if (nZ(IndexI)<MinMemb) 
                    TEMP = Z(:,Nc-1); 
                    if  IndexI~=Nc-1 
                        TEMP (:,IndexI:Nc-1) = Z(:,IndexI+1:Nc); 
                    end 
                    OK = 0; 
                    Nc = Nc - 1; 
                    nZ = zeros(Nc,1); 
                    break; 
                end 
            end 
            if OK==1 
                bSepOK = 1; 
            end 
        end 
         
         
        %????4 ????????????????????????µ?????µ??????????????????????? 
        %??????????µ????? 
        Z = zeros(nDim,Nc); 
        for IndexI = 1:nTotalData 
            TEMP = Result(1,IndexI);%TEMP??µ?IndexI????±?µ????? 
            Z(:,TEMP) = Z(:,TEMP) + RawData(:,IndexI); 
        end 
        for IndexI = 1:Nc 
            Z(:,IndexI) = Z(:,IndexI)/nZ(IndexI); 
        end         
         %????????????µ?????µ????????? 
        dInDis = zeros(1,Nc);   %????»????????????? 
        dTDis = 0;              %????»??????????? 
        %????????µ????????????? 
        for IndexI = 1:nTotalData 
            TEMP = Result(1,IndexI);%TEMP??µ?IndexI????±?µ????? 
            dInDis(TEMP) = dInDis(TEMP) + sqrt((RawData(:,IndexI)-Z(:,TEMP))'*(RawData(:,IndexI)-Z(:,TEMP))); 
        end 
        for IndexI = 1:Nc 
            dInDis(IndexI) = dInDis(IndexI)/nZ(IndexI); 
            dTDis = dTDis + nZ(IndexI)*dInDis(IndexI); 
        end         
        %???????????????? 
        dTDis = dTDis / nTotalData; 
         
         
        %·????????????° ????nLOOP,Nc??¶????? 
        bNeedDivide = 0; 
        bNeedJoint = 0; 
        if (nLOOP == MaxLoops) 
            JoinLevel = 0; 
            bNeedJoint = 1; 
        elseif Nc<=c/2 
            bNeedDivide = 1; 
        elseif Nc>=2*c 
            bNeedJoint = 1; 
        elseif mod(nLOOP,2)==0 
            bNeedJoint = 1; 
        else 
            bNeedDivide = 1; 
        end 
         
        %%·????¦?? 
        if (bNeedDivide~=0) 
            %µ????? ??????????????µ?±????????? 
            bNeedDivide = 0; 
            Delta = zeros(Nc,nDim); 
            for IndexI = 1:nTotalData 
                TEMP = Result(1,IndexI);%TEMP??µ?IndexI????±?µ????? 
                for IndexJ = 1:nDim 
                    Delta(TEMP,IndexJ) = Delta(TEMP,IndexJ) + (RawData(IndexJ,IndexI) - Z(IndexJ,TEMP)).^2; 
                end 
            end 
            for IndexI = 1:Nc 
                for IndexJ = 1:nDim 
                    Delta(IndexI,IndexJ) = sqrt(Delta(IndexI,IndexJ)./nZ(IndexI)); 
                end 
            end 
            %µ??????¬???????»??????±?????????µ?????·??? 
            DeltaMax = max(Delta'); 
            DeltaMaxN = DeltaMax; 
            for IndexI = 1:Nc 
                for IndexJ = 1:nDim 
                    if (Delta(IndexI,IndexJ) ==DeltaMax(IndexI)) 
                       DeltaMaxN(IndexI) = IndexJ; 
                       break; 
                    end 
                end 
            end 
             
            %µ?°????¬??¶???·?????·??? 
            IndexI=0; 
            for IndexI = 1:Nc 
                if DeltaMax(IndexI)>MinSquare 
                    if (dInDis(1,IndexI)>dTDis | (Nc ==1)) & (nZ(IndexI)>2*(MinMemb+1)) & (Nc<=c/2) 
                        bNeedDivide = 1; 
                        break; 
                    end 
                end 
            end 
            if (bNeedDivide == 0) 
                bNeedJoint = 1; 
            else 
                %????·??????? 
                TEMP = zeros(nDim,Nc+1); 
                TEMP(:,1:Nc) = Z; 
                TEMP(:,Nc+1) = Z(:,IndexI); 
                DT = Delta'; 
                TEMP(DeltaMaxN(IndexI),IndexI) = TEMP(DeltaMaxN(IndexI),IndexI) + 0.5*DT(DeltaMaxN(IndexI),IndexI); 
                TEMP(DeltaMaxN(IndexI),Nc+1) = TEMP(DeltaMaxN(IndexI),Nc+1) - 0.5*DT(DeltaMaxN(IndexI),IndexI); 
                Nc = Nc + 1; 
                Z = TEMP; 
            end 
         end 
         
        %?????¦?? 
        if (bNeedJoint~=0) 
            %µ??????¬?????¦?? 
            %??????????¶????????? 
            ED = zeros(Nc,Nc); 
            for IndexI = 1:Nc 
                for IndexJ = 1:Nc 
                    if (IndexI<IndexJ) 
                        ED(IndexI,IndexJ) = sqrt((Z(:,IndexI)-Z(:,IndexJ))'*(Z(:,IndexI)-Z(:,IndexJ))); 
                    else 
                        ED(IndexI,IndexJ) = Inf; 
                    end 
                end 
            end 
            %?????¬????µ???????µ??????? 
            %??????·?L????¶? 
            Sorted = zeros(L,2); 
            %????L???»»»??¶? 
            for IndexK = 1:L 
                %??µ?????µ??? 
                MinDis = Inf; 
                MinPos = [0,0]; 
                for IndexI = 1:Nc 
                    for IndexJ = 1:Nc 
                        if (IndexI<IndexJ) 
                            if MinDis>=ED(IndexI,IndexJ) 
                                MinDis = ED(IndexI,IndexJ); 
                                MinPos = [IndexI,IndexJ]; 
                            end 
                        end 
                    end 
                end 
                %??¶?????µ???????·?????JoinLevel 
                if MinDis>=JoinLevel 
                    break; 
                end 
                %?·???????????????????????? 
                Sorted(IndexK,1) = MinPos(1); 
                Sorted(IndexK,2) = MinPos(2); 
                %???­????µ????????»???????? 
                ED(MinPos(1),:) = Inf; 
                ED(:,MinPos(2)) = Inf; 
            end 
            %?????? 
            count = 0; 
            for IndexI = 1:L 
                %?????¬Sorted(x,1)<Sorted(x,2) 
                if (Sorted(IndexI,1)==0|Sorted(IndexI,2)==0) 
                    break; 
                end 
                TEMP = (nZ(Sorted(IndexI,1))*Z(:,Sorted(IndexI,1))+nZ(Sorted(IndexI,2))*Z(:,Sorted(IndexI,2)))/(nZ(Sorted(IndexI,1))+nZ(Sorted(IndexI,2))); 
                %????°?????µ???±?????Inf 
                Z(:,Sorted(IndexI,1)) = TEMP; 
                Z(:,Sorted(IndexI,2)) = Inf; 
                count = count + 1; 
            end 
            %??????µ??????? 
            TEMP = zeros(nDim,Nc-count); 
            count = 0; 
            for IndexI = 1:Nc 
                if Z(1,IndexI)~=Inf 
                    count = count + 1; 
                    TEMP(:,count) = Z(:,IndexI); 
                end 
            end 
            Z = TEMP; 
            Nc = count; 
        end 
         
         
        %????Result?»±?»??¬??µ??????? 
        if (OldResult==Result) 
            break; 
        end 
        OldResult=Result; 
        
        % written by Vladislav 
        str = ['iteration = ', num2str(nLOOP)];
        disp(str);
        str = ['Number of clusters = ', num2str(Nc)];
        disp(str);
        str = ['(5) deltaOverall = ', num2str(dTDis)];
        disp(str);

         
    end 
 
    Final.Result = Result; 
    Final.nLOOP = nLOOP; 
    Final.ClassCenter = Z; 
 
end 